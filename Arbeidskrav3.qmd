---
title: "Arbeidskrav 3; Pendling"
author: "Marit Rygg Fredheim & Namra Shahid"
format: 
  html: 
    code-fold: true
  pdf:
    toc: true
editor: visual
---

## Innledning

I denne oppgaven skal vi studere pendle-mønster for regionen Sør-Rogaland (Nord_Jæren)...

### Kommuner Sør-Rogaland 2018

[Fra oppgavetekst: Vi definerer Nord-Jæren som følgende kommuner. Vi tar med både de «gamle» og «nye». Disse kommunene vil bare inneholde data for de årene de har eksistert.\
Sandnes (-2019), Stavanger, Nye-Sandnes, Bjerkreim, Hå, Klepp, Time, Gjesdal, Sola, Randaberg, Forsand (-2019), Strand, Hjelmeland, Finnøy (-2019), Rennesøy (-2019), Kvitsøy.\
De korresponderende kommune-numrene er:\
1102, 1103, 1108, 1114, 1119, 1120, 1121,1122, 1124, 1127, 1129, 1130, 1133, 1141, 1142, 1144.\
Det er verdt å merke seg at fra 1.1.2020 har vi 1108 Sandnes som består av 1102 Sandnes og 1129 Forsand. Vi har også 1103 Stavanger som består av 1103 Stavanger, 1141 Finnøy (-2019) og 1142 Rennesøy (-2019).\
Vi ser at kommunesammenslåing blir behandlet ulikt for de to. Sandnes får nytt knr, mens Stavanger beholder sitt gamle.]{.underline}

[I tillegg ble en mindre del av Forsand skilt ut og slått sammen med Strand kommune. Her vil vi se bort fra dette og legge alle arbeidstakere fra Forsand til «Nye Sandnes» (1108). Det er langt vanskeligere å håndtere en splitting av kommuner enn en sammenslåing.]{.underline}\

```{r}
library(PxWebApiData)
library(dplyr)
library(ggplot2)
library(parallel)
library(tidyverse)
```

## Hente data fra SSB

```{r}
# ag: foreslår å legge dette i en variabel
#Get more info about table
meta03321 <- ApiData(
"http://data.ssb.no/api/v0/en/table/03321",
returnMetaFrames = TRUE
)
```

Det vi gjør her er at vi henter in data i R, fra SSB (statistisk sentralbyrå).
Vi henter data fra statistikktabell 03321.

Den første rammen viser, kode

```{r}
#| cache: true
#gererate knr
# Må være en character vector for at SSB skal skjønne hva vi spør etter
knr <- as.character(c(1102, 1103, 1108, 1114, 1119, 1120, 1121,1122, 1124, 
                    1127, 1129, 1130, 1133, 1141, 1142, 1144))
```

```{r}
tid <- as.character(2000:2021)
```

```{r}
#| cache: true
pend_00_21_ssb_arbNJ <- ApiData(
  urlToData = "03321",
  ArbstedKomm = knr,
  Bokommuen = list('*'),
  Tid = tid
    )
```

```{r}
names(pend_00_21_ssb_arbNJ)[1] <- "desc_arbNJ"
```

```{r}
#| cache: true
pend_00_21_arbNJ <- pend_00_21_ssb_arbNJ$dataset %>%
# Observasjonene i dataset og desc_ komponenten er ordnet i samme rekkefølge 
#  så vi trenger bare hente variablen
  rename(
    aar = Tid
  ) %>% 
  mutate(
    akom_navn = pend_00_21_ssb_arbNJ$desc_arbNJ$arbeidsstedskommune,
    bkom_navn = pend_00_21_ssb_arbNJ$desc_arbNJ$bostedskommune,
    akom = paste("k", ArbstedKomm, sep = ""),
    bkom = paste("k", Bokommuen, sep = ""),
    pendlere = value,
  ) %>% 
  select(aar, akom, akom_navn, bkom, bkom_navn, pendlere) %>%
  as_tibble()
```

```{r}
print(pend_00_21_arbNJ, n = 5)
```

```{r}
#| cache: true
pend_00_21_ssb_boNJ <- ApiData(
  urlToData = "03321",
  ArbstedKomm = list('*'),
  Bokommuen = knr,
  Tid = tid
    )
```

```{r}
names(pend_00_21_ssb_boNJ)[1] <- "desc_boNJ"
```

```{r}
#| cache: true
# Lager pend_00_21_boNJ fra pend_00_21_ssb_boNJ
pend_00_21_boNJ <- pend_00_21_ssb_boNJ$dataset %>% 
  # Henter kommune navn fra desc_boNJ df
  mutate(
    akom_navn = pend_00_21_ssb_boNJ$desc_boNJ$arbeidsstedskommune,
    bkom_navn = pend_00_21_ssb_boNJ$desc_boNJ$bostedskommune,
    akom = paste("k", ArbstedKomm, sep = ""),
    bkom = paste("k", Bokommuen, sep = "")
  ) %>% 
  # Endrer noen variabelnavn
  rename(
    aar = Tid,
    pendlere = value 
  )  %>%
  select(aar, akom, akom_navn, bkom, bkom_navn, pendlere) %>% 
  as_tibble()
```

```{r}
pend_00_21_boNJ <- pend_00_21_ssb_boNJ$dataset %>%
  rename(
    aar = Tid
  ) %>%
  mutate(akom_navn = pend_00_21_ssb_boNJ$desc_boNJ$arbeidsstedskommune, 
         bkom_navn = pend_00_21_ssb_boNJ$desc_boNJ$bostedskommune, 
         akom = paste("k", ArbstedKomm, sep = ""),
         bkom = paste("k", Bokommuen, sep = ""),
         pendlere = value,
      ) %>%
  
  select(aar, akom, akom_navn, bkom, bkom_navn, pendlere) %>%

  as_tibble()
```

```{r}
print(pend_00_21_boNJ, n = 5)
```

### Kommunesammenslåingene

```{r}
# knr Nord Jæren utenom kommunene som inngår i Nye Stavanger
# og Nye Sandnes
knr_u_SS <- paste(
  "k",
  c(
    1114, 1119, 1120, 1121, 1122, 1124, 1127, 1130, 1133, 1144
    ),
  sep = ""
)
```

### Bosted Nord-Jæren

```{r}
#pend_00_21_boNJ
pend_00_21_boNJ <- pend_00_21_boNJ %>%
  mutate(
    nye_bkom = case_when(
      bkom %in% c("k1102", "k1108", "k1129") ~ "k1108",
      bkom %in% c("k1103", "k1141", "k1142") ~ "k1103",
      # Øvrige Nord- Jæren beholder sin bkom
      TRUE ~ bkom
    ),
  nye_bkom_navn = case_when(
    bkom %in% c("k1102", "k1108", "k1129") ~ "Sandnes",
    bkom %in% c("k1103", "k1141", "k1142") ~ "Stavanger",
    # Øvrige Nord- Jæren beholder sitt bkom_navn
    TRUE ~ bkom_navn
  ),
  nye_akom = case_when(
    akom %in% c("k1102", "k1108", "k1129") ~ "k1108",
    akom %in% c("k1103", "k1141", "k1142") ~ "k1103",
    # Øvrige Nord- Jæren beholder sin akom
    akom %in% knr_u_SS ~ akom,
    # Resten av landet kodes som knr "9999"
    TRUE ~ "k9999"
  ),
  nye_akom_navn = case_when(
    akom %in% c("k1102", "k1108", "k1129") ~ "Sandnes",
    akom %in% c("k1103", "k1141", "k1142") ~ "Stavanger",
    # Øvrige Nord- Jæren beholder sitt akom_navn
    akom %in% knr_u_SS ~ akom_navn,
# Resten av landet kodes som knr "RAL"
    TRUE ~ "RAL"
  )
)
```

```{r}
# pend_00_21_boNJ_agg
pend_00_21_boNJ_agg <- pend_00_21_boNJ |>
  group_by(aar, nye_bkom, nye_akom, 
          nye_bkom_navn, nye_akom_navn) |>
  summarise(pendlere = sum(pendlere)) |>
  ungroup() |>
  select(aar, nye_akom, nye_akom_navn, nye_bkom, nye_bkom_navn, pendlere)
```

```{r}
pend_00_21_boNJ_agg |>
  distinct(nye_bkom) |>
  pull(nye_bkom)
```

```{r}
pend_00_21_boNJ_agg |>
  distinct(nye_akom) |>
  pull(nye_akom)
```

```{r}
pend_00_21_boNJ_agg |>
  distinct(nye_akom_navn) |>
  pull(nye_akom_navn)
```

### Arbeidssted Nord-Jæren

```{r}
#pend_00_21_arbNJ
pend_00_21_arbNJ <- pend_00_21_arbNJ %>%
  mutate(
    nye_akom = case_when(
      akom %in% c("k1102", "k1108", "k1129") ~ "k1108",
      akom %in% c("k1103", "k1141", "k1142") ~ "k1103",
      # Øvrige Nord- Jæren beholder sin akom
      TRUE ~ akom
    ),
  nye_akom_navn = case_when(
    # ag: rettet fra bkom til akom. Ikke lett å finne ;-)
    akom %in% c("k1102", "k1108", "k1129") ~ "Sandnes",
    akom %in% c("k1103", "k1141", "k1142") ~ "Stavanger",
    # Øvrige Nord- Jæren beholder sitt akom_navn
    TRUE ~ akom_navn
  ),
  nye_bkom = case_when(
    bkom %in% c("k1102", "k1108", "k1129") ~ "k1108",
    bkom %in% c("k1103", "k1141", "k1142") ~ "k1103",
    # Øvrige Nord- Jæren beholder sin bkom
    bkom %in% knr_u_SS ~ bkom,
    # Resten av landet kodes som knr "9999"
    TRUE ~ "k9999"
  ),
  nye_bkom_navn = case_when(
    bkom %in% c("k1102", "k1108", "k1129") ~ "Sandnes",
    bkom %in% c("k1103", "k1141", "k1142") ~ "Stavanger",
    # Øvrige Nord- Jæren beholder sitt bkom_navn
    bkom %in% knr_u_SS ~ bkom_navn,
    # Resten av landet kodes som knr "RAL"
    TRUE ~ "RAL"
  )
)
```

```{r}
# pend_00_21_arbNJ_agg
pend_00_21_arbNJ_agg <- pend_00_21_arbNJ |>
  group_by(aar, nye_bkom, nye_akom, 
          nye_bkom_navn, nye_akom_navn) |>
  summarise(pendlere = sum(pendlere)) |>
  ungroup() |>
  select(aar, nye_akom, nye_akom_navn, nye_bkom, nye_bkom_navn, pendlere)
```

```{r}
pend_00_21_arbNJ_agg |>
  distinct(nye_akom) |>
  pull(nye_akom)
```

```{r}
pend_00_21_arbNJ_agg |>
  distinct(nye_bkom) |>
  pull(nye_bkom)
```

```{r}
pend_00_21_arbNJ_agg <- pend_00_21_arbNJ_agg |>
  rename(
    akom = nye_akom,
    akom_navn = nye_akom_navn,
    bkom = nye_bkom,
    bkom_navn = nye_bkom_navn 
  )
```

```{r}
pend_00_21_boNJ_agg <- pend_00_21_boNJ_agg |>
  rename(
    akom = nye_akom,
    akom_navn = nye_akom_navn,
    bkom = nye_bkom,
    bkom_navn = nye_bkom_navn 
  )
```

```{r}
names(pend_00_21_arbNJ_agg)
```

Her finner vi forskjellige navn på datasettet arbNJ

```{r}
names(pend_00_21_boNJ_agg)
```

Her finner vi ytterligere navn på datasettet boNJ

```{r}
boNJ_arb_RAL <- pend_00_21_boNJ_agg |>
  filter(akom == "k9999")

pend_00_21 <- bind_rows(
  pend_00_21_arbNJ_agg,
  boNJ_arb_RAL)
```

Det vi har gjor her er at vi har slått sammen begge datasettene, i dette tilfelle: pend_00_21_arbNJ_agg og pend_00_21_boNJ_agg.

```{r}
rm(boNJ_arb_RAL, pend_00_21_arbNJ, pend_00_21_boNJ, pend_00_21_ssb_arbNJ, pend_00_21_ssb_boNJ
   )
```

Test

```{r}
# pendlematrise 2010, bo Nord-Jæren
pend_00_21 |>
  ungroup() |>
  filter(aar == "2010") |>
  select(bkom, akom, pendlere) |>
  pivot_wider(
    names_from = akom,
    values_from = pendlere
  ) |>
  as.data.frame() |>
  print(width = 110)

 pend_00_21 %>%
    dplyr::group_by(bkom, akom) %>%
    dplyr::summarise(n = dplyr::n(), .groups = "drop") %>%
    dplyr::filter(n > 1L)
```

## Totalt antall arbeidstakere i hele landet per år:

Oppe ser vi at vi har hentet data fra tabell: 11616.
Denne gir oss data data på fylke-basis.
Det vi gjorde var at vi hentet data for årene 2000-2021, for begge kjønn.
Vi fant dataen for alderen 15-74 år.
Vi fant data utifra hvor arbeidstakerne er bosatt.
Det intensjonen her er totalt antall arbeidstakere per år.

```{r}
meta11616 <- ApiData(
"http://data.ssb.no/api/v0/en/table/11616",
returnMetaFrames = TRUE
)
```

```{r}
#| eval: false
# ag: Trengs ikke dere har definert vektoren tid lengre oppe
Tid <- as.character(2000:2021)
```

```{r}
#| eval: false
#ag: ???
value <- as.character
```

```{r}
#| eval: false
# ag: ???
arbeidstakere <- ApiData(11616)
```

# AG: Henter data om totalt antall arbeidstakere fra SSB

Definerer først alle fylkesnummerene.
Henter data for fylker da vi bare er interessert i totalen.

```{r}
#| echo: true
fnr <- c(
  "30", "01", "02", "06", "03", "34", "04", "05", "38",
  "07", "08", "42", "09", "10", "11", "46", "12", "14",
  "15", "50", "16", "17", "18", "54", "19", "20"
  )
```

Hent vha.
`ApiData()` opplysninger fra tabell 11616 om antall arbeidstakere bosatt i hvert fylke årene 2000 til 2021.

```{r}
#| cache: true
# Henter fra 11616 for der kan vi hente sysselsatte per fylke
# bytter til mitt navn så er det lettere å følge
# arbeidstakere <- ApiData(
tot_arb_HL <- ApiData(
    urlToData = "11616",
    Region = fnr,
    Kjonn = c("1", "2"),
    Alder = "15-74",
    ContentsCode = "Bosatt",
    Tid = as.character(2000:2021)
)
```

Vi lager en tibble med to variabler, «Tid» (dvs. årstall) og «arbtak_HL».

```{r}
names(tot_arb_HL)[1] <- "desc_arbHL"
```

AG: Foreslår å ta bort en del av følgende kode.
Vi trenger egentlig bare dataset fra tot_arb_HL.
Se forslag til kode lengre nede.

```{r}
#| eval: false
# tot_arb_HL <- tot_arb_HL$dataset %>%
#   rename(
#     aar = Tid,
#   ) %>% 
#   mutate(
#     fnr = tot_arb_HL$dataset$Region,
#     tot_arb_HL1 = tot_arb_HL$desc_arbHL$value
#   ) %>% 
#   select(aar, fnr, tot_arb_HL1) %>%
#   as_tibble()
```

```{r}
#arbeidstakereHL %>%
#group_by(aar, fnr)
```

```{r}
#| eval: false
# Tar denne ut
# tot_arb_HL_ny <- tot_arb_HL |>
#   group_by(aar, fnr) |>
#   summarise(tot_arb_HL = sum(tot_arb_HL1), by = aar) |>
#   ungroup() |>
#   select(aar, tot_arb_HL)|>
#   group_by(aar, tot_arb_HL) |>
#   summarise(tot_arb_HL = sum(tot_arb_HL), by = aar)
```

```{r}
# ag: endret
#tot_arb_HL_ny[!duplicated(tot_arb_HL_ny$tot_arb_HL), ]

```

Gjør heller

```{r}
#ag
tot_arb_HL <- tot_arb_HL$dataset %>% 
  group_by(Tid) %>% 
  summarise(arbtakHL = sum(value)) %>% 
  ungroup() %>% 
  rename(aar = Tid) %>% 
  as_tibble()
```

```{r}
print(tot_arb_HL)
```

AG: Da har vi totalt antall arbeidstakere med minimalt arbeid.

Øverst ser vi at vi har nå funnet opplysninger fra tabell 11616 ved hjelp av ApiData().

```{r}
#as_tibble(11616)
#tid
#NJ
```

**Bor NJ jobber HL**

Definerer Nord-Jæren (NJ)

```{r}
NJ <- c(knr_u_SS, "k1103", "k1108")
```

Legger antall som bor på Nord-Jæren og jobber utenfor region i bNJjHL

```{r}
bNJjHL <- pend_00_21 %>%
  filter(bkom %in% NJ) %>%
  group_by(aar) %>%
  summarise(pendlere_bNJjHL = sum(pendlere))
```

**Bor RAL jobber på NJ**

```{r}
bRALjNJ <- pend_00_21 %>%
  filter(bkom %in% c("k9999")) %>%
  filter(akom %in% NJ) %>% 
  group_by(aar) %>%
  summarise(pendlere_bRALjNJ = sum(pendlere))
```

```{r}
tot_arb_HL <- left_join(tot_arb_HL, bNJjHL)
tot_arb_HL <- left_join(tot_arb_HL, bRALjNJ)
```

Da kan vi regne ut antallet som bor i RAL og jobber i RAL

```{r}
tot_arb_HL <- tot_arb_HL %>% 
  mutate(
    bRALjRAL = arbtakHL - pendlere_bNJjHL - pendlere_bRALjNJ
  )
```

Lager p_bRALjRAL

```{r}
p_bRALjRAL <- tot_arb_HL %>% 
  select(aar, pendlere = bRALjRAL) %>% 
  mutate(
    akom = "k9999",
    akom_navn = "RAL",
    bkom = "k9999",
    bkom_navn = "RAL"
  ) %>% 
  select(aar, akom, akom_navn, bkom, bkom_navn, pendlere)
```

```{r}
pend_00_21 <- bind_rows(pend_00_21, p_bRALjRAL)
```

```{r}
# pendlematrise 2010, bo Nord-Jæren
pend_00_21 |>
  ungroup() |>
  filter(aar == "2010") |>
  select(bkom, akom, pendlere) |>
  pivot_wider(
    names_from = akom,
    values_from = pendlere
  ) |>
  as.data.frame() |>
  print(width = 110)
```

```{r}
totalt_arb <- pend_00_21 |>
group_by(aar, akom, akom_navn) |>
summarise(pendlere = sum(pendlere)) |>
mutate(
bkom = "k0000",
bkom_navn = "Totalt_arb"
)
```

```{r}
totalt_bo <- pend_00_21 |>
group_by(aar, bkom, bkom_navn) |>
summarise(pendlere = sum(pendlere)) |>
mutate(
akom = "k0000",
akom_navn = "Totalt_bo"
)
```

Bruker nå bind_rows() for å nå legge inn datene

```{r}
dim(pend_00_21_boNJ_agg)
```

```{r}
names(pend_00_21_boNJ_agg)
```

```{r}
print(pend_00_21_boNJ_agg, n = 5)
```

Vi kan også regne ut andel av arbeidstakerne som bor i en kommune, som jobber i de ulike kommunene:

# AG: Da skulle ting kjøre til hit

```{r}
dim(andel_pend_00_21_boNJ_agg)
```

```{r}
names(andel_pend_00_21_boNJ_agg)
```

```{r}
print(andel_pend_00_21_boNJ_agg)
```

Nå skal vi long før plot:

gjør resten imorgen

## Bor og jobber i samme kommune på Nord-Jæren

### Internpendling et utvalg kommuner Hvor jobber folk bosatt i Stavanger kommune? Hvor jobber folk bosatt i Sandnes kommune? Hvor jobber folk bosatt i Sola kommune? Hvor jobber folk bosatt i Randaberg kommune? Hvor jobber folk bosatt i Klepp kommune? Hvor jobber folk bosatt i Time kommune? Hvor jobber folk bosatt i Gjesdal kommune?

### Hvor jobber folk bosatt i Hå kommune? Hvor jobber folk bosatt i Bjerkreim kommune? Hvor jobber folk bosatt i Strand kommune? Hvor stor pendling er det fra resten av landet til Nord-Jæren?

## Pendlematriser

### 2000

### 2005

### 2010

### 2015

### 2021

```{r}
#| echo: false
# siste
```
